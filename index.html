<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SQLite DB Loader + Barcode Scanner</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        padding: 20px;
        text-align: center;
    }
    h1 {
        color: #333;
    }
    button {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
    }
    button:disabled {
        background: #888;
        cursor: not-allowed;
    }
    #status {
        margin-top: 15px;
        font-size: 14px;
        color: #555;
    }
    #reader {
        width: 300px;
        margin: 20px auto;
    }
    table {
        margin: 20px auto;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    th, td {
        border: 1px solid #ccc;
        padding: 8px 12px;
    }
    th {
        background: #eee;
    }
</style>
</head>
<body>

<h1>SQLite DB Loader + Barcode Scanner</h1>
<button id="startBtn">Start Process</button>
<button id="scanBtn" disabled>Scan Barcode</button>
<div id="status">Waiting...</div>
<div id="reader"></div>
<div id="result"></div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
let db = null;

const startBtn = document.getElementById('startBtn');
const scanBtn = document.getElementById('scanBtn');
const statusDiv = document.getElementById('status');
const resultDiv = document.getElementById('result');

startBtn.addEventListener('click', async () => {
    startBtn.disabled = true;
    statusDiv.textContent = "Downloading ZIP...";

    try {
        const response = await fetch('DM.db.43.0.zip');
        if (!response.ok) throw new Error('HTTP error ' + response.status);

        const arrayBuffer = await response.arrayBuffer();
        statusDiv.textContent = "Unzipping...";

        const zip = await JSZip.loadAsync(arrayBuffer);
        const fileName = Object.keys(zip.files)[0];
        const dbData = await zip.files[fileName].async('uint8array');

        statusDiv.textContent = "Loading database...";
        const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
        db = new SQL.Database(dbData);

        statusDiv.textContent = "Database loaded. You can now scan.";
        scanBtn.disabled = false;
    } catch (err) {
        console.error(err);
        statusDiv.textContent = "Error: " + err.message;
        startBtn.disabled = false;
    }
});

scanBtn.addEventListener('click', () => {
    document.getElementById('reader').innerHTML = "";
    const html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
            html5QrCode.stop().then(() => {
                statusDiv.textContent = "Scanned: " + decodedText;
                searchBarcode(decodedText);
            }).catch(err => console.error("Stop failed", err));
        },
        (errorMessage) => {
            // ignore scan errors
        }
    ).catch(err => {
        console.error(err);
        statusDiv.textContent = "Camera error: " + err;
    });
});

function searchBarcode(barcode) {
    if (!db) {
        statusDiv.textContent = "DB not loaded!";
        return;
    }

    try {
        const stmt = db.prepare("SELECT * FROM CS WHERE Barcode = ?");
        stmt.bind([barcode]);
        const rows = [];
        while (stmt.step()) {
            rows.push(stmt.getAsObject());
        }
        stmt.free();

        if (rows.length > 0) {
            renderTable(rows);
        } else {
            resultDiv.innerHTML = "<p>No matching record found.</p>";
        }
    } catch (err) {
        console.error(err);
        resultDiv.innerHTML = "<p>Error: " + err.message + "</p>";
    }
}

function renderTable(data) {
    if (!data.length) return;
    let html = "<table><tr>";
    Object.keys(data[0]).forEach(key => {
        html += `<th>${key}</th>`;
    });
    html += "</tr>";

    data.forEach(row => {
        html += "<tr>";
        Object.values(row).forEach(val => {
            html += `<td>${val !== null ? val : ''}</td>`;
        });
        html += "</tr>";
    });
    html += "</table>";

    resultDiv.innerHTML = html;
}
</script>

</body>
</html>