<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Barcode Lookup</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <h2>üì¶ Barcode Lookup</h2>

  <button onclick="scanBarcode()">üîç Scan Barcode</button>
  <input type="text" id="barcodeInput" placeholder="Enter Barcode" style="margin-left: 10px;">
  <div id="result" style="margin-top: 20px; font-family: monospace;"></div>

  <script>
    const zipUrl = "https://github.com/jatts/DM/raw/main/DM.db.44.1.zip";
    let db = null;

    async function initDatabase() {
      document.getElementById("result").innerText = "üì• Downloading ZIP...";

      try {
        // Fetch ZIP file
        const zipData = await fetch(zipUrl).then(res => res.arrayBuffer());

        // Load ZIP using JSZip
        const zip = await JSZip.loadAsync(zipData);

        // Find .db file inside zip
        let dbFile = null;
        zip.forEach((relativePath, zipEntry) => {
          if (relativePath.endsWith(".db")) {
            dbFile = zipEntry;
          }
        });

        if (!dbFile) throw new Error("‚ùå .db file not found in ZIP.");

        // Extract DB file as Uint8Array
        const dbArray = await dbFile.async("uint8array");

        // Load SQL.js
        const SQL = await initSqlJs({ locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${filename}` });

        db = new SQL.Database(dbArray);

        document.getElementById("result").innerText = "‚úÖ Database Loaded. Ready to scan.";
      } catch (e) {
        document.getElementById("result").innerText = "‚ùå Error: " + e.message;
      }
    }

    async function scanBarcode() {
      if (!db) {
        alert("Database not loaded yet!");
        return;
      }

      const barcode = document.getElementById("barcodeInput").value.trim();

      if (!barcode) {
        alert("Please enter a barcode.");
        return;
      }

      try {
        const stmt = db.prepare("SELECT * FROM sc WHERE Barcode = ?");
        stmt.bind([barcode]);

        if (stmt.step()) {
          const result = stmt.getAsObject();
          let html = "<h3>‚úÖ Barcode Found</h3><pre>" + JSON.stringify(result, null, 2) + "</pre>";
          document.getElementById("result").innerHTML = html;
        } else {
          document.getElementById("result").innerHTML = "‚ùå Barcode not found in sc table.";
        }

        stmt.free();
      } catch (e) {
        document.getElementById("result").innerText = "‚ùå Query error: " + e.message;
      }
    }

    // Auto load DB on page open
    initDatabase();
  </script>
</body>
</html>
