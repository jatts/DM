<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SQLite + Barcode Scanner</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f2f2f2; }
button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
button:hover { background: #0056b3; }
#resultTable { border-collapse: collapse; margin-top: 15px; width: 100%; }
#resultTable th, #resultTable td { border: 1px solid #ccc; padding: 8px; text-align: left; }
#reader { width: 300px; margin-top: 20px; }
</style>
</head>
<body>

<h2>SQLite + Barcode Scanner</h2>
<button onclick="startProcess()">Start Process</button>
<button onclick="showTables()">Show Tables</button>
<button onclick="startBarcodeScan()">Scan Barcode</button>

<div id="reader" style="display:none;"></div>
<div id="output"></div>

<script>
let db = null;

async function startProcess() {
    const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm` });
    const response = await fetch('DM.db.43.0.zip');
    const arrayBuffer = await response.arrayBuffer();
    const zip = await JSZip.loadAsync(arrayBuffer);
    const dbFile = Object.keys(zip.files).find(name => name.endsWith('.db'));
    const dbData = await zip.files[dbFile].async("uint8array");
    db = new SQL.Database(dbData);
    alert("Database loaded!");
}

function showTables() {
    if (!db) return alert("Load DB first!");
    const res = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
    let html = "<h3>Tables:</h3><ul>";
    res[0].values.forEach(row => { html += `<li>${row[0]}</li>`; });
    html += "</ul>";
    document.getElementById("output").innerHTML = html;
}

function startBarcodeScan() {
    if (!db) return alert("Load DB first!");
    document.getElementById("reader").style.display = "block";
    const html5QrCode = new Html5Qrcode("reader");

    const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 100 },
        formatsToSupport: [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E
        ]
    };

    html5QrCode.start(
        { facingMode: "environment" }, 
        config,
        barcode => {
            html5QrCode.stop();
            document.getElementById("reader").style.display = "none";
            searchBarcode(barcode);
        },
        errorMessage => {
            console.warn("Scanning error:", errorMessage);
        }
    );
}

function searchBarcode(barcode) {
    if (!db) return alert("DB not loaded!");
    console.log("Scanned:", barcode);

    try {
        const stmt = db.prepare(`
            SELECT Barcode, Article, Percentage, OriginalPrice 
            FROM SC 
            WHERE TRIM(Barcode) = TRIM(?) 
            OR CAST(Barcode AS INTEGER) = CAST(? AS INTEGER)
        `);
        stmt.bind([barcode, barcode]);

        let html = "";
        if (stmt.step()) {
            const row = stmt.getAsObject();
            html = `<h3>Match Found</h3>
            <table id="resultTable">
                <tr><th>Barcode</th><th>Article</th><th>Percentage</th><th>OriginalPrice</th></tr>
                <tr>
                    <td>${row.Barcode}</td>
                    <td>${row.Article}</td>
                    <td>${row.Percentage}</td>
                    <td>${row.OriginalPrice}</td>
                </tr>
            </table>`;
        } else {
            html = "<p>No matching record found.</p>";
        }
        stmt.free();
        document.getElementById("output").innerHTML = html;

    } catch (e) {
        console.error(e);
        alert("Error: " + e.message);
    }
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>